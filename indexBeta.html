<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘å‡±ç‘ä½ å¿ƒğŸ’</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: #2c2c2c;
            color: white;
        }

        /* æ··éŸ³å™¨å€åŸŸ */
        .mixer-section {
            flex: 1;
            padding: 20px;
            background: #3c3c3c;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .mixer-container {
            display: flex;
            gap: 20px;
            align-items: end;
        }

        .mixer-channel {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .mixer-label {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .volume-slider {
            writing-mode: bt-lr;
            -webkit-appearance: slider-vertical;
            width: 30px;
            height: 200px;
            background: #666;
            outline: none;
            cursor: pointer;
        }

        .volume-value {
            font-size: 12px;
            color: #ccc;
        }

        /* æ’­æ”¾æ§åˆ¶å€åŸŸ */
        .player-section {
            flex: 1;
            padding: 20px;
            background: #4c4c4c;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .player-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .control-btn {
            background: #666;
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .control-btn:hover {
            background: #777;
        }

        .play-btn {
            background: #28a745;
            padding: 15px 20px;
            font-size: 18px;
        }

        .play-btn:hover {
            background: #218838;
        }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .speed-slider {
            width: 100px;
        }

        /* é€²åº¦æ¢æ¨£å¼ */
        .progress-container {
            display: flex;
            align-items: center;
            gap: 15px;
            width: 100%;
            max-width: 500px;
        }

        .time-display {
            font-size: 14px;
            color: #ccc;
            min-width: 45px;
            text-align: center;
        }

        .progress-bar-container {
            flex: 1;
            position: relative;
            height: 20px;
            display: flex;
            align-items: center;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #666;
            border-radius: 3px;
            position: relative;
            cursor: pointer;
        }

        .progress-fill {
            height: 100%;
            background: #28a745;
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s ease;
        }

        .progress-handle {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 16px;
            background: #28a745;
            border-radius: 50%;
            cursor: grab;
            left: 0%;
            transition: left 0.1s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .progress-handle:active {
            cursor: grabbing;
            transform: translate(-50%, -50%) scale(1.2);
        }

        .progress-handle:hover {
            transform: translate(-50%, -50%) scale(1.1);
        }

        /* è²éƒ¨é¸æ“‡å€åŸŸ */
        .voice-section {
            flex: 1;
            padding: 20px;
            background: #2c2c2c;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .voice-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .voice-btn {
            background: #666;
            border: none;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            min-width: 60px;
            transition: all 0.3s ease;
        }

        .voice-btn:hover {
            background: #777;
        }

        .voice-btn.active {
            background: #28a745;
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
        }

        .voice-btn.active:hover {
            background: #218838;
        }

        /* Loading ä»‹é¢æ¨£å¼ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-family: Arial, sans-serif;
        }

        .loading-img {
            width: 200px;
            height: 200px;
            background: url('image.png') no-repeat center center;
            background-size: contain;
            margin-bottom: 20px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #666;
            border-top: 4px solid #28a745;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .loading-overlay.hidden {
            display: none;
        }
    </style>
</head>

<body>
    <!-- Loading ä»‹é¢ -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-img"></div>
        <div class="loading-spinner"></div>
        <div class="loading-text">æ­£åœ¨è¼‰å…¥éŸ³æª”...</div>
        <div class="loading-text">iphoneæ‰‹æ©Ÿè¨˜å¾—ä¸è¦é—œé–‰é€šçŸ¥</div>
    </div>

    <!-- æ··éŸ³å™¨å€åŸŸ -->
    <div class="mixer-section">
        <div class="mixer-container">
            <div class="mixer-channel">
                <div class="mixer-label">S1</div>
                <input type="range" class="volume-slider" id="volume-s1" min="0" max="100" value="50" orient="vertical">
                <div class="volume-value" id="value-s1">50</div>
            </div>
            <div class="mixer-channel">
                <div class="mixer-label">S2</div>
                <input type="range" class="volume-slider" id="volume-s2" min="0" max="100" value="50" orient="vertical">
                <div class="volume-value" id="value-s2">50</div>
            </div>
            <div class="mixer-channel">
                <div class="mixer-label">A</div>
                <input type="range" class="volume-slider" id="volume-a" min="0" max="100" value="50" orient="vertical">
                <div class="volume-value" id="value-a">50</div>
            </div>
            <div class="mixer-channel">
                <div class="mixer-label">T</div>
                <input type="range" class="volume-slider" id="volume-t" min="0" max="100" value="50" orient="vertical">
                <div class="volume-value" id="value-t">50</div>
            </div>
            <div class="mixer-channel">
                <div class="mixer-label">B1</div>
                <input type="range" class="volume-slider" id="volume-b1" min="0" max="100" value="50" orient="vertical">
                <div class="volume-value" id="value-b1">50</div>
            </div>
            <div class="mixer-channel">
                <div class="mixer-label">B2</div>
                <input type="range" class="volume-slider" id="volume-b2" min="0" max="100" value="50" orient="vertical">
                <div class="volume-value" id="value-b2">50</div>
            </div>
            <div class="mixer-channel">
                <div class="mixer-label">ç¯€æ‹</div>
                <input type="range" class="volume-slider" id="volume-temp" min="0" max="100" value="80"
                    orient="vertical">
                <div class="volume-value" id="value-temp">80</div>
            </div>
        </div>
    </div>

    <!-- æ’­æ”¾æ§åˆ¶å€åŸŸ -->
    <div class="player-section">
        <div class="player-controls">
            <button class="control-btn" id="prev-btn">-5ç§’</button>
            <button class="control-btn play-btn" id="play-btn">æ’­æ”¾</button>
            <button class="control-btn" id="next-btn">+5ç§’</button>
        </div>

        <!-- é€²åº¦æ¢ -->
        <div class="progress-container">
            <div class="time-display" id="current-time">00:00</div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                    <div class="progress-handle" id="progress-handle"></div>
                </div>
            </div>
            <div class="time-display" id="total-time">00:00</div>
        </div>

        <div class="speed-control">
            <label>æ’­æ”¾é€Ÿåº¦ï¼š</label>
            <input type="range" class="speed-slider" id="speed-slider" min="0.5" max="2" step="0.1" value="1">
            <span id="speed-value">1.0x</span>
        </div>
    </div>

    <!-- è²éƒ¨é¸æ“‡å€åŸŸ -->
    <div class="voice-section">
        <div class="voice-buttons">
            <button class="voice-btn active" id="voice-all">å…¨</button>
            <button class="voice-btn" id="voice-s1">S1</button>
            <button class="voice-btn" id="voice-s2">S2</button>
            <button class="voice-btn" id="voice-a">A</button>
            <button class="voice-btn" id="voice-t">T</button>
            <button class="voice-btn" id="voice-b1">B1</button>
            <button class="voice-btn" id="voice-b2">B2</button>
        </div>
    </div>

    <footer style="text-align: center; padding: 10px; background: #1c1c1c; color: #888; font-size: 12px;">
        <span>ä¸è¦ç©éŸ³æª”è®Šé€Ÿï¼Œæœƒæœ‰èŠ±æ —é¼ ï¼Œä½†æˆ‘æ‡¶å¾—ä¿®äº†</span>
    </footer>

    <script>
        // éŸ³æª”è·¯å¾‘é…ç½®
        const audioFiles = {
            's1': 's1.mp3',
            's2': 's2.mp3',
            'a': 'a.mp3',
            't': 't.mp3',
            'b1': 'b1.mp3',
            'b2': 'b2.mp3',
            'temp': 'temp.mp3'
        };

        // Pure Web Audio API è®Šæ•¸
        let audioContext;
        let audioBuffers = {};
        let audioSources = {};
        let gainNodes = {};
        let currentlySelected = 'all';
        // é€²éšæ’­æ”¾æ§åˆ¶ (Web Audio)
        let playbackRate = 1.0;   // å…¨åŸŸæ’­æ”¾é€Ÿåº¦
        let baseStartTime = null; // AudioContext åƒè€ƒèµ·é»ï¼šç•¶ currentTime=0 æ™‚ï¼ŒaudioContext.currentTime çš„å€¼
        // æ’­æ”¾æ™‚é–“ç‹€æ…‹ï¼ˆéœ€æ–¼æ‰€æœ‰ä½¿ç”¨å‰å®£å‘Šï¼‰
        let currentTime = 0;
        let totalTime = 0;



        // Loading ç‹€æ…‹è¿½è¹¤
        let loadedCount = 0;
        const totalCount = Object.keys(audioFiles).length;
        const loadingOverlay = document.getElementById('loading-overlay');

        // åˆå§‹åŒ– Web Audio API
        function initWebAudio() {
            try {
                // æª¢æŸ¥ç€è¦½å™¨æ”¯æ´
                const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                if (!AudioContextClass) {
                    throw new Error('ç€è¦½å™¨ä¸æ”¯æ´ Web Audio API');
                }
                
                audioContext = new AudioContextClass({
                    sampleRate: 44100, // å¼·åˆ¶ä½¿ç”¨æ¨™æº–æ¡æ¨£ç‡
                    latencyHint: 'interactive'
                });
                
                console.log('ğŸ§ Web Audio API åˆå§‹åŒ–æˆåŠŸ');
                console.log(`   ç‹€æ…‹: ${audioContext.state}`);
                console.log(`   æ¡æ¨£ç‡: ${audioContext.sampleRate} Hz`);
                console.log(`   åŸºæº–æ™‚é–“: ${audioContext.baseLatency?.toFixed(3) || 'N/A'} ç§’`);
                
                return true;
            } catch (e) {
                console.error('âŒ Web Audio API åˆå§‹åŒ–å¤±æ•—:', e.message);
                return false;
            }
        }

        // iOS AudioContext å•Ÿå‹•
        async function resumeAudioContext() {
            if (audioContext && audioContext.state === 'suspended') {
                try {
                    await audioContext.resume();
                    console.log('AudioContext å·²å•Ÿå‹•');
                    return true;
                } catch (e) {
                    console.error('AudioContext å•Ÿå‹•å¤±æ•—:', e);
                    return false;
                }
            }
            return true;
        }

        // è¼‰å…¥éŸ³æª”ç‚º Web Audio ç·©è¡å€ï¼ˆå«é€¾æ™‚å’Œé‡è©¦æ©Ÿåˆ¶ï¼‰
        async function loadAudioAsBuffer(voice, url) {
            const maxRetries = 2;
            let lastError = null;
            
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    console.log(`ğŸµ ${voice} è¼‰å…¥å˜—è©¦ ${attempt}/${maxRetries}: ${url}`);
                    
                    // å‰µå»ºå¸¶é€¾æ™‚çš„ fetch
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => {
                        controller.abort();
                        console.log(`â±ï¸ ${voice} è¼‰å…¥é€¾æ™‚ (attempt ${attempt})`);
                    }, 15000); // 15ç§’é€¾æ™‚
                    
                    const response = await fetch(url, { 
                        signal: controller.signal,
                        cache: 'no-cache' // é¿å… GitHub Pages å¿«å–å•é¡Œ
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    console.log(`ğŸ“¥ ${voice} ä¸‹è¼‰å®Œæˆï¼Œé–‹å§‹è§£ç¢¼...`);
                    const arrayBuffer = await response.arrayBuffer();
                    
                    if (!arrayBuffer || arrayBuffer.byteLength === 0) {
                        throw new Error('éŸ³æª”å…§å®¹ç‚ºç©º');
                    }
                    
                    console.log(`ğŸ” ${voice} æª”æ¡ˆå¤§å°: ${(arrayBuffer.byteLength / 1024).toFixed(1)} KB`);
                    
                    // ä½¿ç”¨ Promise åŒ…è£ decodeAudioDataï¼ˆå…¼å®¹æ€§æ›´å¥½ï¼‰
                    const audioBuffer = await new Promise((resolve, reject) => {
                        console.log(`ğŸ§ ${voice} é–‹å§‹éŸ³é »è§£ç¢¼...`);
                        
                        // ç¾ä»£ç€è¦½å™¨çš„ Promise ç‰ˆæœ¬
                        if (audioContext.decodeAudioData.length === 1) {
                            audioContext.decodeAudioData(arrayBuffer.slice())
                                .then(buffer => {
                                    console.log(`âœ¨ ${voice} è§£ç¢¼æˆåŠŸ (ç¾ä»£API)`);
                                    resolve(buffer);
                                })
                                .catch(error => {
                                    console.error(`ğŸ’¥ ${voice} è§£ç¢¼å¤±æ•— (ç¾ä»£API):`, error);
                                    reject(new Error(`è§£ç¢¼å¤±æ•—: ${error.message}`));
                                });
                        } else {
                            // èˆŠç€è¦½å™¨çš„ callback ç‰ˆæœ¬
                            console.log(`ğŸ”„ ${voice} ä½¿ç”¨èˆŠç‰ˆ API è§£ç¢¼...`);
                            audioContext.decodeAudioData(
                                arrayBuffer.slice(),
                                buffer => {
                                    console.log(`âœ¨ ${voice} è§£ç¢¼æˆåŠŸ (èˆŠç‰ˆAPI)`);
                                    resolve(buffer);
                                },
                                error => {
                                    console.error(`ğŸ’¥ ${voice} è§£ç¢¼å¤±æ•— (èˆŠç‰ˆAPI):`, error);
                                    reject(new Error(`èˆŠç‰ˆAPIè§£ç¢¼å¤±æ•—: ${error?.message || 'æœªçŸ¥éŒ¯èª¤'}`));
                                }
                            );
                        }
                        
                        // è§£ç¢¼è¶…æ™‚ä¿è­·
                        setTimeout(() => {
                            console.error(`â° ${voice} è§£ç¢¼è¶…æ™‚`);
                            reject(new Error('è§£ç¢¼è¶…æ™‚ï¼ˆå¯èƒ½æ˜¯éŸ³æª”æ ¼å¼å•é¡Œï¼‰'));
                        }, 10000); // 10ç§’è§£ç¢¼è¶…æ™‚
                    });
                    audioBuffers[voice] = audioBuffer;
                    
                    console.log(`âœ… ${voice} Web Audio è¼‰å…¥å®Œæˆ, æ™‚é•·: ${audioBuffer.duration.toFixed(2)}ç§’`);
                    
                    // è¨­å®šä¸»éŸ³æª”æ™‚é•·ï¼ˆæ’é™¤ tempï¼‰
                    if (!totalTime && voice !== 'temp') {
                        totalTime = audioBuffer.duration;
                        updateProgress();
                        console.log('ğŸµ è¨­å®šä¸»éŸ³æª”æ™‚é•·:', totalTime.toFixed(2));
                    }
                    
                    return true;
                    
                } catch (error) {
                    lastError = error;
                    const errorMsg = error.name === 'AbortError' ? 'è¼‰å…¥é€¾æ™‚' : error.message;
                    console.error(`âŒ ${voice} è¼‰å…¥å¤±æ•— (attempt ${attempt}): ${errorMsg}`);
                    
                    if (attempt < maxRetries) {
                        const delay = attempt * 1000; // éå¢å»¶é²
                        console.log(`ğŸ”„ ${voice} å°‡åœ¨ ${delay}ms å¾Œé‡è©¦...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }
            
            console.error(`ğŸ’” ${voice} ç¶“é ${maxRetries} æ¬¡å˜—è©¦ä»ç„¶å¤±æ•—:`, lastError?.message || 'æœªçŸ¥éŒ¯èª¤');
            return false;
        }

        // åˆå§‹åŒ–éŸ³æª” - ç´” Web Audio æ¨¡å¼
        async function initializeAudio() {
            console.log('ğŸš€ é–‹å§‹åˆå§‹åŒ–éŸ³æª” - Pure Web Audio æ¨¡å¼');
            
            // åˆå§‹åŒ– Web Audio API
            const webAudioReady = initWebAudio();
            
            if (!webAudioReady) {
                console.error('âŒ ç€è¦½å™¨ä¸æ”¯æ´ Web Audio APIï¼');
                alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ Web Audio APIï¼Œè«‹ä½¿ç”¨è¼ƒæ–°çš„ç€è¦½å™¨ (Chrome 14+, Firefox 25+, Safari 6+)');
                return;
            }
            
            console.log(`ğŸ“‹ æº–å‚™è¼‰å…¥ ${totalCount} å€‹éŸ³æª”: ${Object.keys(audioFiles).join(', ')}`);
            
            // è¨­å®šè¼‰å…¥è¶…æ™‚ä¿è­· (GitHub Pages å¯èƒ½è¼ƒæ…¢)
            const timeoutId = setTimeout(() => {
                console.warn('â° è¼‰å…¥è¶…æ™‚ï¼Œå¼·åˆ¶å®Œæˆè¼‰å…¥ç¨‹åº');
                const successCount = Object.keys(audioBuffers).length;
                if (successCount > 0) {
                    console.log(`ğŸ‰ è¶…æ™‚ä¿è­·è§¸ç™¼ï¼Œå·²è¼‰å…¥ ${successCount}/${totalCount} å€‹éŸ³æª”`);
                    hideLoading();
                } else {
                    console.error('âŒ è¶…æ™‚ä¸”ç„¡ä»»ä½•éŸ³æª”è¼‰å…¥æˆåŠŸ');
                    alert('éŸ³æª”è¼‰å…¥è¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šä¸¦é‡æ–°æ•´ç†é é¢');
                }
            }, 30000); // 30ç§’è¶…æ™‚
            
            try {
                // ä½¿ç”¨ Promise.allSettled ç­‰å¾…æ‰€æœ‰è¼‰å…¥å®Œæˆï¼ˆç„¡è«–æˆåŠŸæˆ–å¤±æ•—ï¼‰
                const audioEntries = Object.entries(audioFiles);
                const loadPromises = audioEntries.map(async ([voice, url], index) => {
                    console.log(`ğŸ”„ [${index + 1}/${totalCount}] é–‹å§‹è¼‰å…¥ ${voice}: ${url}`);
                    
                    try {
                        const success = await loadAudioAsBuffer(voice, url);
                        if (success) {
                            console.log(`âœ… [${index + 1}/${totalCount}] ${voice} è¼‰å…¥æˆåŠŸ`);
                            return { voice, success: true };
                        } else {
                            console.error(`âŒ [${index + 1}/${totalCount}] ${voice} è¼‰å…¥å¤±æ•—`);
                            return { voice, success: false };
                        }
                    } catch (error) {
                        console.error(`ğŸ’¥ [${index + 1}/${totalCount}] ${voice} è¼‰å…¥ç•°å¸¸:`, error);
                        return { voice, success: false, error: error.message };
                    }
                });

                console.log('â³ ç­‰å¾…æ‰€æœ‰éŸ³æª”è¼‰å…¥å®Œæˆ...');
                const results = await Promise.allSettled(loadPromises);
                
                clearTimeout(timeoutId);
                
                // çµ±è¨ˆçµæœ
                const successResults = results.filter(r => 
                    r.status === 'fulfilled' && r.value.success
                );
                const failedResults = results.filter(r => 
                    r.status === 'rejected' || (r.status === 'fulfilled' && !r.value.success)
                );
                
                console.log(`ğŸ“Š è¼‰å…¥çµæœçµ±è¨ˆ:`);
                console.log(`   âœ… æˆåŠŸ: ${successResults.length}/${totalCount}`);
                console.log(`   âŒ å¤±æ•—: ${failedResults.length}/${totalCount}`);
                
                if (successResults.length > 0) {
                    console.log(`ğŸŠ è¼‰å…¥å®Œæˆï¼è¼‰å…¥æˆåŠŸçš„éŸ³æª”: ${Object.keys(audioBuffers).join(', ')}`);
                    hideLoading();
                    
                    // è¨­å®šåˆå§‹éŸ³é‡
                    setTimeout(() => {
                        setVolumeAndUI('all');
                        console.log('ğŸ”Š åˆå§‹éŸ³é‡è¨­å®šå®Œæˆ');
                    }, 100);
                } else {
                    console.error('ğŸ’” æ²’æœ‰ä»»ä½•éŸ³æª”è¼‰å…¥æˆåŠŸ');
                    alert('æ‰€æœ‰éŸ³æª”è¼‰å…¥å¤±æ•—ï¼\nå¯èƒ½åŸå› ï¼š\n1. ç¶²è·¯é€£ç·šå•é¡Œ\n2. éŸ³æª”æª”æ¡ˆä¸å­˜åœ¨\n3. GitHub Pages å¿«å–å•é¡Œ\n\nè«‹é‡æ–°æ•´ç†é é¢é‡è©¦ã€‚');
                }
                
            } catch (error) {
                clearTimeout(timeoutId);
                console.error('ğŸš¨ è¼‰å…¥ç¨‹åºç™¼ç”Ÿåš´é‡éŒ¯èª¤:', error);
                alert(`è¼‰å…¥å¤±æ•—: ${error.message}\n\nè«‹é‡æ–°æ•´ç†é é¢é‡è©¦ã€‚`);
            }

            console.log('ğŸš€ Pure Web Audio è¼‰å…¥ç¨‹åºå•Ÿå‹•å®Œæˆ');
        }

        // éš±è— Loading ä»‹é¢
        function hideLoading() {
            const loadedVoices = Object.keys(audioBuffers);
            const allVoices = Object.keys(audioFiles);
            const missingVoices = allVoices.filter(v => !loadedVoices.includes(v));
            
            console.log('ğŸŠ Loading å®Œæˆçµ±è¨ˆ:');
            console.log(`   âœ… æˆåŠŸè¼‰å…¥: ${loadedVoices.length}/${allVoices.length}`);
            console.log(`   ğŸ“‹ å·²è¼‰å…¥éŸ³æª”: [${loadedVoices.join(', ')}]`);
            
            if (missingVoices.length > 0) {
                console.warn(`   âš ï¸  ç¼ºå°‘éŸ³æª”: [${missingVoices.join(', ')}]`);
            }
            
            loadingOverlay.classList.add('hidden');
            console.log('ğŸšª Loading ä»‹é¢å·²éš±è—');
        }

        // é¡¯ç¤º Loading ä»‹é¢ (å¯ç”¨æ–¼é‡æ–°è¼‰å…¥)
        function showLoading() {
            loadedCount = 0;
            loadingOverlay.classList.remove('hidden');
        }

        // (ç§»é™¤) HTML5 åŒæ­¥å‡½å¼ï¼šWeb Audio éœ€é€éé‡å»º BufferSource ä¾†é”æˆ seek

        // æ›´æ–°æ»‘æ¡¿ä½ç½®å’Œé¡¯ç¤ºæ•¸å€¼çš„å‡½æ•¸
        function updateSlider(voiceKey, volume) {
            const slider = document.getElementById(`volume-${voiceKey}`);
            const valueDisplay = document.getElementById(`value-${voiceKey}`);
            if (slider && valueDisplay) {
                const sliderValue = Math.round(volume * 100);
                slider.value = sliderValue;
                valueDisplay.textContent = sliderValue;
            }
        }

        // éŸ³é‡è¨­å®šå‡½æ•¸ (Pure Web Audio)
        function setVolumeForVoice(voiceKey, volume) {
            // Web Audio éŸ³é‡æ§åˆ¶
            if (gainNodes[voiceKey]) {
                gainNodes[voiceKey].gain.value = volume;
                console.log(`ğŸ”Š ${voiceKey} éŸ³é‡è¨­ç‚º: ${(volume * 100).toFixed(0)}%`);
            }
            // æ›´æ–°æ»‘æ¡¿é¡¯ç¤º
            updateSlider(voiceKey, volume);
        }

        // è¨­å®šéŸ³é‡å’Œæ›´æ–°ä»‹é¢çš„å‡½æ•¸ (Aæ–¹æ³•)
        function setVolumeAndUI(selectedVoice) {
            console.log('è¨­å®šéŸ³é‡å’Œæ›´æ–°ä»‹é¢:', selectedVoice);

            switch (selectedVoice) {
                case 'all':
                    // å…¨éƒ¨è²éƒ¨æ¨¡å¼ï¼šæ‰€æœ‰è²éƒ¨éƒ½æ˜¯æ­£å¸¸éŸ³é‡
                    setVolumeForVoice('s1', 0.5);
                    setVolumeForVoice('s2', 0.5);
                    setVolumeForVoice('a', 0.5);
                    setVolumeForVoice('t', 0.5);
                    setVolumeForVoice('b1', 0.5);
                    setVolumeForVoice('b2', 0.5);
                    // temp éŸ³é‡ä¿æŒä¸è®Š
                    break;

                case 's1':
                    // S1é‡é»æ¨¡å¼ï¼šS1éŸ³é‡0.9ï¼Œå…¶ä»–è²éƒ¨0.1
                    setVolumeForVoice('s1', 0.9);
                    setVolumeForVoice('s2', 0.1);
                    setVolumeForVoice('a', 0.1);
                    setVolumeForVoice('t', 0.1);
                    setVolumeForVoice('b1', 0.1);
                    setVolumeForVoice('b2', 0.1);
                    // temp éŸ³é‡ä¿æŒä¸è®Š
                    break;

                case 's2':
                    // S2é‡é»æ¨¡å¼ï¼šS2éŸ³é‡0.9ï¼Œå…¶ä»–è²éƒ¨0.1
                    setVolumeForVoice('s1', 0.1);
                    setVolumeForVoice('s2', 0.9);
                    setVolumeForVoice('a', 0.1);
                    setVolumeForVoice('t', 0.1);
                    setVolumeForVoice('b1', 0.1);
                    setVolumeForVoice('b2', 0.1);
                    break;

                case 'a':
                    // Aé‡é»æ¨¡å¼ï¼šAéŸ³é‡0.9ï¼Œå…¶ä»–è²éƒ¨0.1
                    setVolumeForVoice('s1', 0.1);
                    setVolumeForVoice('s2', 0.1);
                    setVolumeForVoice('a', 0.9);
                    setVolumeForVoice('t', 0.1);
                    setVolumeForVoice('b1', 0.1);
                    setVolumeForVoice('b2', 0.1);
                    break;

                case 't':
                    // Té‡é»æ¨¡å¼ï¼šTéŸ³é‡0.9ï¼Œå…¶ä»–è²éƒ¨0.1
                    setVolumeForVoice('s1', 0.1);
                    setVolumeForVoice('s2', 0.1);
                    setVolumeForVoice('a', 0.1);
                    setVolumeForVoice('t', 0.9);
                    setVolumeForVoice('b1', 0.1);
                    setVolumeForVoice('b2', 0.1);
                    break;

                case 'b1':
                    // B1é‡é»æ¨¡å¼ï¼šB1éŸ³é‡0.9ï¼Œå…¶ä»–è²éƒ¨0.1
                    setVolumeForVoice('s1', 0.1);
                    setVolumeForVoice('s2', 0.1);
                    setVolumeForVoice('a', 0.1);
                    setVolumeForVoice('t', 0.1);
                    setVolumeForVoice('b1', 0.9);
                    setVolumeForVoice('b2', 0.1);
                    break;

                case 'b2':
                    // B2é‡é»æ¨¡å¼ï¼šB2éŸ³é‡0.9ï¼Œå…¶ä»–è²éƒ¨0.1
                    setVolumeForVoice('s1', 0.1);
                    setVolumeForVoice('s2', 0.1);
                    setVolumeForVoice('a', 0.1);
                    setVolumeForVoice('t', 0.1);
                    setVolumeForVoice('b1', 0.1);
                    setVolumeForVoice('b2', 0.9);
                    break;

                default:
                    console.log('æœªçŸ¥çš„è²éƒ¨é¸æ“‡:', selectedVoice);
                    break;
            }
        }

        // æ’­æ”¾æ‰€æœ‰éŸ³æª” (Pure Web Audio)
        async function playSelectedVoices() {
            console.log('ğŸµ é–‹å§‹ Web Audio æ’­æ”¾');
            
            // ç¢ºä¿ AudioContext å·²å•Ÿå‹• (iOS/Android éœ€è¦ç”¨æˆ¶äº’å‹•)
            const contextReady = await resumeAudioContext();
            if (!contextReady) {
                console.error('âŒ AudioContext ç„¡æ³•å•Ÿå‹•');
                alert('éŸ³é »æ’­æ”¾éœ€è¦ç”¨æˆ¶äº’å‹•ï¼Œè«‹é‡æ–°é»æ“Šæ’­æ”¾æŒ‰éˆ•');
                return;
            }
            
            // æª¢æŸ¥éŸ³æª”æ˜¯å¦è¼‰å…¥å®Œæˆ æ‡‰è©²ä¸æœƒç”¨åˆ°
            if (Object.keys(audioBuffers).length < totalCount) {
                console.warn('â³ éŸ³æª”å°šæœªè¼‰å…¥å®Œæˆ');
                return;
            }
            
            // åœæ­¢ä¹‹å‰çš„æ’­æ”¾ (é¿å…å±¤ç–Š)
            Object.keys(audioSources).forEach(key => {
                if (audioSources[key]) {
                    try { audioSources[key].stop(); } catch (e) {}
                    delete audioSources[key];
                }
            });
            
            console.log(`ğŸš€ åŒæ™‚å•Ÿå‹• ${Object.keys(audioBuffers).length} å€‹éŸ³è»Œ (offset=${currentTime.toFixed(2)})`);

            // è¨­å®šåŸºæº–é–‹å§‹æ™‚é–“ï¼Œä¾›é€²åº¦æ¢èˆ‡ seek ä½¿ç”¨
            baseStartTime = audioContext.currentTime - currentTime / playbackRate;
            
            // åŒæ™‚å•Ÿå‹•æ‰€æœ‰éŸ³è»Œ - çœŸæ­£çš„åŒæ­¥æ’­æ”¾ï¼
            Object.keys(audioBuffers).forEach(key => {
                const source = audioContext.createBufferSource();
                const gainNode = audioContext.createGain();
                
                source.buffer = audioBuffers[key];
                source.playbackRate.value = playbackRate;
                source.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // è¨­å®šéŸ³é‡ï¼ˆä½¿ç”¨çµ±ä¸€çš„éŸ³é‡é‚è¼¯ï¼‰
                let volume = 0.5; // é è¨­éŸ³é‡
                if (key === 'temp') {
                    volume = 0.8; // ç¯€æ‹éŸ³æª”
                } else if (currentlySelected !== 'all') {
                    volume = (currentlySelected === key) ? 0.9 : 0.1;
                }
                gainNode.gain.value = volume;
                
                // å¾æŒ‡å®šæ™‚é–“é–‹å§‹æ’­æ”¾
                source.start(0, currentTime);
                audioSources[key] = source;
                gainNodes[key] = gainNode;
                
                console.log(`âœ… ${key} å•Ÿå‹•æˆåŠŸ (volume=${(volume*100).toFixed(0)}%, rate=${playbackRate})`);
            });
        }

        // (å·²ç§»é™¤é‡è¤‡çš„ setWebAudioVolume å‡½æ•¸ï¼Œæ”¹ç”¨å…§è¯éŸ³é‡è¨­å®š)

        // æš«åœæ‰€æœ‰éŸ³æª” (Pure Web Audio)
        function pauseAllAudio() {
            console.log('â¸ï¸ åœæ­¢æ‰€æœ‰ Web Audio æ’­æ”¾');
            
            // åœæ­¢æ‰€æœ‰éŸ³æº
            Object.keys(audioSources).forEach(key => {
                if (audioSources[key]) {
                    try { audioSources[key].stop(); } catch (e) {}
                    delete audioSources[key];
                }
            });
            
            // æ¸…ç©º gainNodes åƒè€ƒ
            Object.keys(gainNodes).forEach(key => {
                delete gainNodes[key];
            });

            stopPlayback();
        }

        // è¨­å®šéŸ³æª”æ’­æ”¾ä½ç½® (Pure Web Audio)
        function setAudioTime(time) {
            currentTime = Math.max(0, Math.min(totalTime, time));
            console.log(`â° è¨­å®šæ’­æ”¾æ™‚é–“: ${currentTime.toFixed(2)}ç§’`);
            if (isPlaying) {
                restartPlaybackAtCurrentTime();
            } else {
                updateProgress();
            }
        }

        function restartPlaybackAtCurrentTime() {
            console.log('ğŸ”„ é‡æ–°å»ºç«‹æ‰€æœ‰ä¾†æºä»¥å¥—ç”¨æ–°çš„æ™‚é–“/é€Ÿåº¦');
            pauseAllAudio();
            playSelectedVoices();
            startPlayback();
        }

        // éŸ³é‡æ§åˆ¶
        const volumeSliders = document.querySelectorAll('.volume-slider');
        volumeSliders.forEach(slider => {
            const valueDisplay = document.getElementById(slider.id.replace('volume', 'value'));
            const voiceKey = slider.id.replace('volume-', '').replace('-', '');

            slider.addEventListener('input', function () {
                valueDisplay.textContent = this.value;
                const volume = this.value / 100;
                
                // Pure Web Audio éŸ³é‡æ§åˆ¶
                if (gainNodes[voiceKey]) {
                    gainNodes[voiceKey].gain.value = volume;
                }
                
                console.log(`ğŸ›ï¸ ${voiceKey} éŸ³é‡èª¿æ•´ç‚º: ${this.value}%`);
            });
        });

        // æ’­æ”¾æ§åˆ¶
        const playBtn = document.getElementById('play-btn');
        let isPlaying = false;

        playBtn.addEventListener('click', function () {
            console.log('æ’­æ”¾æŒ‰éˆ•è¢«é»æ“Š, ç•¶å‰ç‹€æ…‹:', isPlaying);
            if (isPlaying) {
                this.textContent = 'æ’­æ”¾';
                isPlaying = false;
                pauseAllAudio();
                console.log('éŸ³æª”å·²æš«åœ');
            } else {
                this.textContent = 'æš«åœ';
                isPlaying = true;
                console.log('é–‹å§‹æ’­æ”¾...');
                restartPlaybackAtCurrentTime();
            }
        });

        // è·³è½‰æ§åˆ¶
        document.getElementById('prev-btn').addEventListener('click', function () {
            setAudioTime(currentTime - 5);
        });

        document.getElementById('next-btn').addEventListener('click', function () {
            setAudioTime(currentTime + 5);
        });

        // é€Ÿåº¦æ§åˆ¶
        const speedSlider = document.getElementById('speed-slider');
        const speedValue = document.getElementById('speed-value');

        speedSlider.addEventListener('input', function () {
            playbackRate = parseFloat(this.value);
            speedValue.textContent = playbackRate + 'x';
            if (isPlaying) {
                restartPlaybackAtCurrentTime();
            }
        });

        // é€²åº¦æ¢æ§åˆ¶
        const progressBar = document.getElementById('progress-bar');
        const progressFill = document.getElementById('progress-fill');
        const progressHandle = document.getElementById('progress-handle');
    const currentTimeDisplay = document.getElementById('current-time');
    const totalTimeDisplay = document.getElementById('total-time');
        let isDragging = false;

        // æ ¼å¼åŒ–æ™‚é–“é¡¯ç¤º
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // æ›´æ–°é€²åº¦æ¢é¡¯ç¤º
        function updateProgress() {
            if (totalTime > 0) {
                const percentage = (currentTime / totalTime) * 100;
                progressFill.style.width = percentage + '%';
                progressHandle.style.left = percentage + '%';
            }
            currentTimeDisplay.textContent = formatTime(currentTime);
            totalTimeDisplay.textContent = formatTime(totalTime);
        }

        // è¨­å®šé€²åº¦ä½ç½®
        function setProgress(percentage, commit = false) {
            currentTime = (percentage / 100) * totalTime;
            if (commit) {
                // åªæœ‰åœ¨ click æˆ–æ‹–æ›³çµæŸæ™‚æ‰çœŸæ­£ seek
                setAudioTime(currentTime);
            }
            // ç„¡è«–æ˜¯å¦ commitï¼Œéƒ½æ›´æ–°è¦–è¦ºé€²åº¦
            updateProgress();
        }

        // é»æ“Šé€²åº¦æ¢è·³è½‰ï¼šç›´æ¥ commit seek
        progressBar.addEventListener('click', function (e) {
            if (!isDragging) {
                const rect = progressBar.getBoundingClientRect();
                const percentage = ((e.clientX - rect.left) / rect.width) * 100;
                setProgress(Math.max(0, Math.min(100, percentage)), true);
            }
        });

        // æ‹–æ›³æ§åˆ¶
        progressHandle.addEventListener('mousedown', function (e) {
            isDragging = true;
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
            e.preventDefault();
        });

        function onMouseMove(e) {
            if (isDragging) {
                const rect = progressBar.getBoundingClientRect();
                const percentage = ((e.clientX - rect.left) / rect.width) * 100;
                // æ‹–æ›³éç¨‹åƒ…æ›´æ–° UIï¼Œä¸é‡å•Ÿæ’­æ”¾
                setProgress(Math.max(0, Math.min(100, percentage)), false);
            }
        }

        function onMouseUp() {
            isDragging = false;
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
            // æ‹–æ›³çµæŸæ™‚æ‰çœŸæ­£ seekï¼ˆè‹¥æ­£åœ¨æ’­æ”¾å‰‡æœƒé‡å»ºä¾†æºï¼‰
            setAudioTime(currentTime);
        }

        // åˆå§‹åŒ–é€²åº¦æ¢
        updateProgress();

        // æ’­æ”¾é€²åº¦åŒæ­¥
        let playInterval;

        function startPlayback() {
            console.log('â¯ï¸ é–‹å§‹ Web Audio é€²åº¦è¿½è¹¤');
            clearInterval(playInterval);
            playInterval = setInterval(() => {
                if (!isDragging) {
                    if (baseStartTime == null) {
                        baseStartTime = audioContext.currentTime - currentTime / playbackRate;
                    }
                    currentTime = (audioContext.currentTime - baseStartTime) * playbackRate;
                    // æª¢æŸ¥æ’­æ”¾æ˜¯å¦çµæŸ
                    if (currentTime >= totalTime) {
                        console.log('ğŸ æ’­æ”¾çµæŸ');
                        playBtn.textContent = 'æ’­æ”¾';
                        isPlaying = false;
                        clearInterval(playInterval);
                        pauseAllAudio();
                        currentTime = totalTime;
                    }
                    updateProgress();
                }
            }, 100);
        }

        function stopPlayback() {
            if (playInterval) {
                clearInterval(playInterval);
                playInterval = null;
            }
        }

        

        // è²éƒ¨é¸æ“‡
        const voiceButtons = document.querySelectorAll('.voice-btn');
        voiceButtons.forEach(button => {
            button.addEventListener('click', function () {
                // ç§»é™¤æ‰€æœ‰activeç‹€æ…‹
                voiceButtons.forEach(btn => btn.classList.remove('active'));
                // æ·»åŠ ç•¶å‰æŒ‰éˆ•çš„activeç‹€æ…‹
                this.classList.add('active');

                // æ›´æ–°ç•¶å‰é¸æ“‡çš„è²éƒ¨
                const buttonText = this.textContent;
                console.log('æŒ‰éˆ•æ–‡å­—:', buttonText);

                if (buttonText === 'å…¨') {
                    currentlySelected = 'all';
                } else {
                    // æ­£ç¢ºæ˜ å°„æŒ‰éˆ•æ–‡å­—åˆ°éŸ³æª”key
                    const voiceMapping = {
                        'S1': 's1',
                        'S2': 's2',
                        'A': 'a',
                        'T': 't',
                        'B1': 'b1',
                        'B2': 'b2'
                    };
                    currentlySelected = voiceMapping[buttonText] || buttonText.toLowerCase();
                }

                console.log('æ˜ å°„å¾Œçš„è²éƒ¨:', currentlySelected);

                // ç«‹å³èª¿ç”¨Aæ–¹æ³•è¨­å®šéŸ³é‡å’Œæ›´æ–°ä»‹é¢
                setVolumeAndUI(currentlySelected);

                // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œé‡æ–°å»ºç«‹ä¾†æºä»¥æ‡‰ç”¨æ–°çš„éŸ³é‡é…ç½®ï¼Œä¿æŒåŒæ­¥
                if (isPlaying) {
                    restartPlaybackAtCurrentTime();
                }

                console.log('é¸æ“‡è²éƒ¨ï¼š', buttonText, '-> ', currentlySelected);
            });
        });

        // ç§»é™¤èˆŠçš„ HTML5 é€Ÿåº¦æ§åˆ¶ï¼Œå·²æ”¹ç‚º Web Audio çš„ playbackRate + é‡å»º

        // åˆå§‹åŒ–éŸ³æª”
        initializeAudio();
    </script>
</body>

</html>